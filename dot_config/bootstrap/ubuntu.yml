---
- name: Ubuntu Machine Setup
  connection: local  # Run on local machine, not over SSH or any remote protocol
  hosts: localhost  # Specifically run on this machine
  become: true  # Run as root
  gather_facts: true  # Collects system information before running tasks  

  tasks:
    - name: Install packages
      ansible.builtin.apt:
        name: "{{ item }}"
        state: present
      loop:
        - build-essential
        - software-properties-common
        - curl
        - wget
        - tree
        - git
        - gh
        - python3
        - python3-pip
        - nodejs
        - npm
        - vim
        - gcc
        - make
        - cmake
        - ripgrep
        - unzip
        - xclip
        - zsh
        - tmux

    # SSH key for github
    - name: Generate ed25519 SSH key for GitHub
      ansible.builtin.openssh_keypair:
        path: "{{ ansible_env.HOME }}/.ssh/github_ed25519"
        type: ed25519
        comment: "{{ ansible_user_id }}@{{ ansible_hostname }}__github"
        state: present

    - name: Get the path to zsh
      ansible.builtin.command: which zsh
      register: zsh_path
      changed_when: false  # Prevent marking the task as changed every time
    - name: Ensure default shell is zsh for "{{ ansible_user_id }}"
      ansible.builtin.user:
        name: "{{ ansible_user_id }}"
        shell: "{{ zsh_path.stdout }}"

    - name: Install Oh My Zsh if not installed
      ansible.builtin.command: |
        sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended --keep-zshrc --skip-chsh
      args:
        creates: "{{ ansible_env.HOME }}/.oh-my-zsh"
