# ------ GENERAL

set -g mouse on
# set -g default-terminal "xterm-256color"
set -ga terminal-overrides ",xterm-256color:Tc" 
set -sg escape-time 0  # escape key timeout, see https://github.com/LunarVim/LunarVim/issues/1857
set -g set-clipboard on

set -g prefix C-a
bind C-a send-prefix  # press C-a twice to send on nested tmux sessions
bind q detach


# ------ DISPLAY

set -g pane-border-lines heavy

set -g base-index 1  # base index numbering from 1, instead of 0
setw -g pane-base-index 1
set -g renumber-windows on  # renumber windows when closing one
setw -g automatic-rename off  # rename window to reflect current program

set -g monitor-activity on  # monitor window activity
set -g visual-activity off  # activity bell and whistles


# ------ NAVIGATION

bind t choose-tree -Zw
bind -r p previous-window
bind -r n next-window
bind q confirm kill-pane
bind Q confirm kill-window

bind c new-window -c "#{pane_current_path}"
# this code below makes restoring tmux with resurrect buggy:
# need to press enter multiple times while the statusbar only showing "Restoring..."
# set-hook -g after-new-window 'command-prompt -I "#{window_name}" "rename-window '%%'"
bind r command-prompt -I'#W' { rename-window -- '%%' }

bind C command-prompt -p "Session name:" "new-session -s '%1'"
bind R command-prompt -I'#S' { rename-session -- '%%' }

bind s split-window -v -c "#{pane_current_path}"
bind v split-window -h -c "#{pane_current_path}"
bind z resize-pane -Z
bind Z break-pane

bind -r j resize-pane -D 2
bind -r k resize-pane -U 2
bind -r l resize-pane -R 2
bind -r h resize-pane -L 2
bind -r w swap-pane -D


# ------ COPY MODE, SCROLL

set -g mode-keys vi
bind Space copy-mode
bind -T copy-mode-vi Escape send -X cancel

unbind -T root MouseDrag1Pane  # disable drag entirely (else you copy it)

bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi C-v send -X rectangle-toggle
bind -T copy-mode-vi y send -X copy-selection-and-cancel

bind -T copy-mode-vi H send -X start-of-line
bind -T copy-mode-vi L send -X end-of-line


# ------ PLUGINS

set -g @plugin_dir "$HOME/.config/tmux/plugins"
if-shell "test ! -d #{@plugin_dir}/tpm" \
    "run-shell 'git clone https://github.com/tmux-plugins/tpm #{@plugin_dir}/tpm'"

set -g @plugin "tmux-plugins/tpm"  # our plugin manager
set -g @plugin "tmux-plugins/tmux-sensible"  # tmux settings everyone agreed
set -g @plugin "christoomey/vim-tmux-navigator"  # better navigation with nvim

# resurrect use prefix + C-s/C-r to save/restore
set -g @plugin 'tmux-plugins/tmux-resurrect'  # persist tmux env across system restarts
set -g @resurrect-dir "$HOME/.config/tmux/resurrect"  # save resurrect data here
set -g @resurrect-capture-pane-contents 'on'  # save pane contents
set -g @resurrect-strategy-nvim 'session'  # save nvim session

set -g @plugin 'tmux-plugins/tmux-continuum'  # automatically saves session every 15m
# set -g @continuum-restore 'on'  # restore saved tmux env on tmux start

set -g @plugin 'niksingh710/minimal-tmux-status'
set -g @minimal-tmux-status "top"
set -g @minimal-tmux-fg "#262626"
set -g @minimal-tmux-bg "#98c379"
set -g @minimal-tmux-indicator-str " C-a "

# Continuum rely on status-right hook or so, so anything modifying that will make autosave not working
# https://github.com/tmux-plugins/tmux-continuum/issues/48
# maybe relevant in the future: https://github.com/tmux-plugins/tmux-continuum/issues/24
set -g @minimal-tmux-status-right-extra "#(#{@plugin_dir}/tmux-continuum/scripts/continuum_save.sh) #{continuum_status}"
# set -g @continuum-save-interval '1'


# ------ REMOTE TMUX SESSIONS (Nesting)

# We want to have single prefix key "C-a", usable both for local and remote session
# we don't want to "C-a" + "a" approach either
# Idea is to turn off all key bindings and prefix handling on local session,
# so that all keystrokes are passed to inner/remote session

# see: toggle on/off all keybindings · Issue #237 · tmux/tmux - https://github.com/tmux/tmux/issues/237

# Also, change some visual styles when window keys are off
bind -T root F12 \
    set prefix None \;\
    set key-table off \;\
    if -F '#{pane_in_mode}' 'send-keys -X cancel' \;\
    refresh-client -S

bind -T off F12 \
    set -u prefix \;\
    set -u key-table \;\
    refresh-client -S

if-shell 'test -n "$SSH_CLIENT"' \
    'set -g @minimal-tmux-status-left-extra "-ssh"'


# ---------------

run-shell '#{@plugin_dir}/tpm/tpm'

# vim: syntax=tmux
